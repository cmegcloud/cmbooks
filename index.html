<!doctype html>
<html lang="en" class="h-full w-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CMB ERP - Enterprise Resource Planning</title>
  
  <meta name="theme-color" content="#5453EC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./iconcmb.png">
  <link rel="icon" type="image/png" href="./iconcmb.png">

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      darkMode: 'class', 
      theme: {
        extend: { fontFamily: { jakarta: ['Plus Jakarta Sans', 'sans-serif'], } }
      }
    }
  </script>
  <style>
    * { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
    html, body { max-width: 100vw; overflow-x: hidden; }
    
    .sidebar-transition { transition: transform 0.3s ease-in-out; }
    .submenu-content { transition: max-height 0.3s ease-in-out; overflow: hidden; }
    
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
    
    .pulse-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .fade-in { animation: fadeIn 0.4s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

    input:focus, select:focus, textarea:focus { border-color: #5453EC !important; outline: none; box-shadow: 0 0 0 2px rgba(84, 83, 236, 0.2); }
  </style>
</head>
<body class="h-full bg-slate-100 dark:bg-slate-900 overflow-hidden w-full relative transition-colors duration-300">
  <div id="app" class="h-full flex w-full relative overflow-hidden">
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden lg:hidden opacity-0 transition-opacity" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="sidebar-transition bg-slate-900 h-full w-72 flex flex-col shadow-2xl fixed lg:relative z-50 transform -translate-x-full lg:translate-x-0 shrink-0">
      
      <div class="p-6 border-b border-slate-700/50 flex items-center gap-3 shrink-0">
        <div class="w-10 h-10 rounded-xl bg-white flex items-center justify-center p-1 shadow-lg">
          <img src="./logocmb.png" alt="Logo" class="max-h-full object-contain" onerror="this.src='https://ui-avatars.com/api/?name=CMB&background=5453EC&color=fff'">
        </div>
        <div>
          <h1 class="text-xl font-bold text-white tracking-tight leading-tight">CMB ERP</h1>
          <p class="text-[10px] text-slate-400 font-medium uppercase tracking-widest">Enterprise</p>
        </div>
      </div>
      
      <div class="p-4 mx-4 mt-4 bg-slate-800/50 rounded-xl border border-slate-700/50 shrink-0">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #5453EC, #F7CB51);">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-[10px] text-slate-500 uppercase tracking-wider font-semibold">Active Company</p>
            <p id="company-name-sidebar" class="text-sm font-semibold text-white truncate">No Company Selected</p>
          </div>
        </div>
      </div>

      <nav class="flex-1 px-4 py-6 overflow-y-auto w-full">
        <ul class="space-y-1 w-full" id="menu-container">
          <li>
            <button onclick="navigateTo('dashboard', 'Dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-white mb-2" style="background: linear-gradient(135deg, #5453EC, #6B63FF); box-shadow: 0 8px 16px rgba(84, 83, 236, 0.3);">
              <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>
              <span class="font-bold text-sm tracking-wide">Dashboard</span>
            </button>
          </li>
          </ul>
      </nav>
      
      <div class="p-4 border-t border-slate-700/50 shrink-0">
        <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-800/50">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#5453EC] to-[#F7CB51] flex items-center justify-center text-white font-bold text-sm">JD</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-white truncate">John Doe</p>
            <p class="text-xs text-slate-400 truncate">Administrator</p>
          </div>
        </div>
      </div>
    </aside>

    <main class="flex-1 h-full flex flex-col relative min-w-0 bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
      
      <header class="bg-white dark:bg-slate-800 shadow-sm border-b border-slate-200 dark:border-slate-700 px-4 py-4 flex items-center justify-between z-10 shrink-0 transition-colors duration-300">
        <div class="flex items-center gap-3">
          <button onclick="toggleSidebar()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors lg:hidden">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
          </button>
          <div class="min-w-0">
            <h2 id="page-title" class="text-lg sm:text-xl font-bold text-slate-800 dark:text-white truncate">Dashboard</h2>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
          <img src="./processiconcmb.gif" id="global-loader" class="w-6 h-6 hidden" alt="Loading">
          
          <div class="hidden md:flex items-center gap-2 px-3 py-2 bg-indigo-50 dark:bg-slate-800 rounded-xl border border-indigo-100 dark:border-slate-700">
            <svg class="w-4 h-4 text-[#5453EC] dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
            <span id="active-company-name" class="text-sm font-bold text-[#5453EC] dark:text-indigo-300 truncate max-w-[150px]">No Company Selected</span>
          </div>

          <button onclick="syncAllData()" class="px-3 sm:px-4 py-2 rounded-xl bg-indigo-50 dark:bg-indigo-500/20 text-[#5453EC] dark:text-indigo-300 font-bold hover:bg-indigo-100 dark:hover:bg-indigo-500/30 transition-all flex items-center gap-2 group shadow-sm">
            <svg id="sync-icon" class="w-4 h-4 transition-transform group-hover:rotate-180 duration-500" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            <span class="text-xs sm:text-sm hidden sm:block">Sync All</span>
          </button>
          <div class="hidden lg:flex items-center gap-2 px-4 py-2 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
            <svg class="w-4 h-4 text-slate-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            <span class="text-sm font-medium text-slate-600 dark:text-slate-300" id="current-date"></span>
          </div>
        </div>
      </header>

      <div class="flex-1 overflow-y-auto p-4 sm:p-6 w-full">
        
        <div id="view-dashboard" class="app-view fade-in w-full">
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="card-hover bg-white dark:bg-slate-800 rounded-2xl p-4 sm:p-6 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
              <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white" style="background: linear-gradient(135deg, #5453EC, #6B63FF);">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <span class="text-emerald-600 dark:text-emerald-400 text-xs font-bold bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded-lg">12.5%</span>
              </div>
              <h3 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">₹ 1,24,563</h3>
              <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 mt-1">Total Revenue</p>
            </div>
            
            <div class="card-hover bg-white dark:bg-slate-800 rounded-2xl p-4 sm:p-6 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
              <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white" style="background: linear-gradient(135deg, #EF4444, #F87171);">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z" /></svg>
                </div>
                <span class="text-red-600 dark:text-red-400 text-xs font-bold bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded-lg">3.2%</span>
              </div>
              <h3 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">₹ 45,890</h3>
              <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 mt-1">Total Expenses</p>
            </div>

            <div class="card-hover bg-white dark:bg-slate-800 rounded-2xl p-4 sm:p-6 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
              <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white" style="background: linear-gradient(135deg, #10b981, #34d399);">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                </div>
                <span class="text-emerald-600 dark:text-emerald-400 text-xs font-bold bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded-lg">18.7%</span>
              </div>
              <h3 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">₹ 78,673</h3>
              <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 mt-1">Net Profit</p>
            </div>

            <div class="card-hover bg-white dark:bg-slate-800 rounded-2xl p-4 sm:p-6 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
              <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white" style="background: linear-gradient(135deg, #F7CB51, #FCD34D);">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                </div>
                <span class="text-amber-600 dark:text-amber-400 text-xs font-bold bg-amber-50 dark:bg-amber-900/30 px-2 py-1 rounded-lg">+248</span>
              </div>
              <h3 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">1,429</h3>
              <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 mt-1">Total Transactions</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6 w-full">
            <div class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-2xl p-4 sm:p-6 shadow-sm border border-slate-100 dark:border-slate-700 relative w-full min-w-0 transition-colors">
              <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Profit & Loss</h3>
              <div class="relative w-full h-64 sm:h-72"><canvas id="plChart"></canvas></div>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 sm:p-6 shadow-sm border border-slate-100 dark:border-slate-700 relative w-full min-w-0 transition-colors">
              <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Sources</h3>
              <div class="relative w-full h-48 sm:h-64 flex justify-center"><canvas id="revenueChart"></canvas></div>
            </div>
          </div>
        </div>

        <div id="view-company-add" class="app-view hidden fade-in w-full max-w-5xl mx-auto">
          <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 sm:p-8 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
            <div class="flex items-center gap-4 mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#5453EC] to-[#F7CB51] flex items-center justify-center text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
              </div>
              <div><h2 id="company-form-title" class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">Create Company</h2><p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">Register a new enterprise entity.</p></div>
            </div>

            <form id="companyForm" onsubmit="submitForm(event, 'COMPANY')" class="space-y-8">
              <input type="hidden" name="action" id="company-action" value="ADD">
              <input type="hidden" name="editId" id="company-editId" value="">

              <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-500 dark:text-slate-400 mb-1">Company ID</label><input type="text" id="display-company-id" value="Auto-Generated" readonly class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 cursor-not-allowed"></div>
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-500 dark:text-slate-400 mb-1">Company Data Path</label><input type="text" name="companyDataPath" placeholder="C:/ERP/Data" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-500 dark:text-slate-400 mb-1">GST No</label><input type="text" name="gstNo" placeholder="22AAAAA0000A1Z5" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                
                <div class="md:col-span-2"><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Company Name *</label><input type="text" name="companyName" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Constitution of Business *</label><select name="constitution" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"><option>Proprietorship</option><option>Partnership</option><option>LLP</option><option>Company</option><option>Others</option></select></div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-5 pt-4 border-t border-slate-100 dark:border-slate-700">
                <div class="md:col-span-2"><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Address Line 1 *</label><input type="text" name="address1" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Address Line 2</label><input type="text" name="address2" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">State *</label><select name="state" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"><option>Kerala</option><option>Tamil Nadu</option><option>Karnataka</option><option>Delhi</option><option>Maharashtra</option></select></div>
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-500 dark:text-slate-400 mb-1">Country</label><input type="text" name="country" value="India" readonly class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 cursor-not-allowed"></div>
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Pincode *</label><input type="text" name="pincode" pattern="[0-9]{6}" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-5 pt-4 border-t border-slate-100 dark:border-slate-700">
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Telephone</label><input type="tel" name="telephone" placeholder="0484-XXXXXXX" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Mobile No *</label>
                  <div class="flex"><span class="inline-flex items-center px-3 rounded-l-xl border border-r-0 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-600 text-slate-500 dark:text-slate-300 text-sm font-semibold">+91</span><input type="tel" name="mobile" required pattern="[0-9]{10}" class="w-full px-4 py-2.5 rounded-r-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white outline-none"></div>
                </div>
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Whatsapp No</label>
                  <div class="flex"><span class="inline-flex items-center px-3 rounded-l-xl border border-r-0 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-600 text-slate-500 dark:text-slate-300 text-sm font-semibold">+91</span><input type="tel" name="whatsapp" pattern="[0-9]{10}" class="w-full px-4 py-2.5 rounded-r-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white outline-none"></div>
                </div>
                <div class="md:col-span-2"><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Email ID *</label><input type="email" name="email" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Website</label><input type="text" name="website" placeholder="www.example.com" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-5 pt-4 border-t border-slate-100 dark:border-slate-700">
                <div class="md:col-span-2"><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">FY Beginning From</label><input type="date" name="fyBeginning" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div class="md:col-span-2"><label class="block text-[10px] font-extrabold uppercase text-slate-600 dark:text-slate-300 mb-1">Books Beginning From</label><input type="date" name="booksBeginning" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-500 dark:text-slate-400 mb-1">Currency Symbol</label><input type="text" name="baseCurrency" value="₹" readonly class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-center font-bold cursor-not-allowed"></div>
                <div><label class="block text-[10px] font-extrabold uppercase text-slate-500 dark:text-slate-400 mb-1">Formal Name</label><input type="text" name="formalName" value="INR" readonly class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-center font-bold cursor-not-allowed"></div>
                
                <div class="md:col-span-2"><label class="block text-[10px] font-extrabold uppercase text-slate-500 dark:text-slate-400 mb-1">Creation Log</label><input type="text" id="creationLog" name="createdLog" readonly class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 text-xs cursor-not-allowed"></div>
              </div>

              <div class="flex justify-end pt-6"><button type="submit" id="company-submit-btn" class="w-full md:w-auto px-10 py-3.5 rounded-xl font-bold text-white transition-transform active:scale-95 shadow-lg flex items-center justify-center gap-2 tracking-wide" style="background: linear-gradient(135deg, #5453EC, #6B63FF);">Generate ID & Save</button></div>
            </form>
          </div>
        </div>

        <div id="view-company-view" class="app-view hidden fade-in w-full max-w-6xl mx-auto">
          <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 sm:p-8 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#5453EC] to-[#F7CB51] flex items-center justify-center text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg></div>
                <div><h2 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">Company Directory</h2><p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">View all registered companies.</p></div>
              </div>
            </div>
            <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
              <table class="w-full min-w-[700px] text-left border-collapse">
                <thead>
                  <tr class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 text-xs uppercase tracking-wider border-b border-slate-200 dark:border-slate-700">
                    <th class="p-4 font-semibold whitespace-nowrap">ID</th>
                    <th class="p-4 font-semibold whitespace-nowrap">Company Name</th>
                    <th class="p-4 font-semibold whitespace-nowrap">Constitution</th>
                    <th class="p-4 font-semibold whitespace-nowrap">State</th>
                    <th class="p-4 font-semibold whitespace-nowrap">Mobile</th>
                    <th class="p-4 font-semibold whitespace-nowrap text-right">Action</th>
                  </tr>
                </thead>
                <tbody id="company-table-body" class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-700 dark:text-slate-300">
                  <tr><td colspan="6" class="p-10 text-center text-slate-400 font-medium">Click "Sync All" in header to fetch data.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="view-stock-add" class="app-view hidden fade-in w-full max-w-5xl mx-auto">
          <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 sm:p-8 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
            <div class="flex items-center gap-4 mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#10b981] to-[#34d399] flex items-center justify-center text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg></div>
              <div><h2 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">Stock Master</h2><p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">Add a new inventory item.</p></div>
            </div>
            <form onsubmit="submitForm(event, 'STOCK')" class="space-y-5">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Item Name *</label><input type="text" name="name" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Under Category</label><input type="text" name="under" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Units</label><input type="text" name="units" placeholder="e.g. Nos, Kgs" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">GST Rate (%)</label><input type="number" name="gstRate" step="0.01" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">HSN/SAC Details</label><input type="text" name="hsnDetails" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Opening Balance</label><input type="number" name="openingBalance" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Cr / Dr</label><select name="crDr" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"><option>Dr</option><option>Cr</option></select></div>
              </div>
              <div class="flex justify-end pt-4"><button type="submit" class="w-full md:w-auto px-8 py-3 rounded-xl font-bold text-white transition-transform active:scale-95 shadow-lg" style="background: linear-gradient(135deg, #10b981, #34d399);">Save Stock Item</button></div>
            </form>
          </div>
        </div>

        <div id="view-ledgers-add" class="app-view hidden fade-in w-full max-w-5xl mx-auto">
          <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 sm:p-8 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
            <div class="flex items-center gap-4 mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#5453EC] to-[#F7CB51] flex items-center justify-center text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg></div>
              <div><h2 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">Ledger Accounts</h2><p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">Create a new ledger.</p></div>
            </div>
            <form onsubmit="submitForm(event, 'LEDGER')" class="space-y-5">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Ledger Name *</label><input type="text" name="ledgerName" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Under Group</label><input type="text" name="under" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Opening Balance</label><input type="number" name="openingBalance" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Cr / Dr</label><select name="crDr" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"><option>Dr</option><option>Cr</option></select></div>
              </div>
              <div class="flex justify-end pt-4"><button type="submit" class="w-full md:w-auto px-8 py-3 rounded-xl font-bold text-white transition-transform active:scale-95 shadow-lg" style="background: linear-gradient(135deg, #5453EC, #6B63FF);">Save Ledger</button></div>
            </form>
          </div>
        </div>

        <div id="view-vouchers-add" class="app-view hidden fade-in w-full max-w-5xl mx-auto">
          <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 sm:p-8 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
            <div class="flex items-center gap-4 mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#F7CB51] to-[#FCD34D] flex items-center justify-center text-slate-900"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg></div>
              <div><h2 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">Voucher Entry</h2><p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">Record a daily transaction.</p></div>
            </div>
            <form onsubmit="submitForm(event, 'TRANSACTION')" class="space-y-5">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Voucher Type *</label><select name="voucherType" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"><option>Payment</option><option>Receipt</option><option>Sales</option><option>Purchase</option><option>Journal</option></select></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Date *</label><input type="date" name="date" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Ledger Name *</label><input type="text" name="ledgerName" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Amount *</label><input type="number" name="amount" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Narration</label><textarea name="narration" rows="2" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></textarea></div>
              </div>
              <div class="flex justify-end pt-4"><button type="submit" class="w-full md:w-auto px-8 py-3 rounded-xl font-bold text-slate-900 transition-transform active:scale-95 shadow-lg" style="background: linear-gradient(135deg, #F7CB51, #FCD34D);">Post Transaction</button></div>
            </form>
          </div>
        </div>

        <div id="view-projects-add" class="app-view hidden fade-in w-full max-w-5xl mx-auto">
          <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 sm:p-8 shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
            <div class="flex items-center gap-4 mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#5453EC] to-[#F7CB51] flex items-center justify-center text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg></div>
              <div><h2 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white">Projects</h2><p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm">Create a new project.</p></div>
            </div>
            <form onsubmit="submitForm(event, 'PROJECTS')" class="space-y-5">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Project Name *</label><input type="text" name="projectName" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Estimated Amount</label><input type="number" name="estimatedAmount" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></div>
                <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-600 dark:text-slate-400 mb-1">Narration</label><textarea name="narration" rows="3" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white"></textarea></div>
              </div>
              <div class="flex justify-end pt-4"><button type="submit" class="w-full md:w-auto px-8 py-3 rounded-xl font-bold text-white transition-transform active:scale-95 shadow-lg" style="background: linear-gradient(135deg, #5453EC, #6B63FF);">Save Project</button></div>
            </form>
          </div>
        </div>

        <div id="module-placeholder" class="app-view hidden fade-in w-full max-w-6xl mx-auto">
            <div class="bg-white dark:bg-slate-800 p-10 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 text-center transition-colors mt-10">
                <div class="w-16 h-16 bg-slate-50 dark:bg-slate-700 rounded-2xl mx-auto flex items-center justify-center mb-4 text-slate-400 dark:text-slate-300">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 002-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                </div>
                <h2 id="module-title" class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Module</h2>
                <p class="text-slate-500 dark:text-slate-400">This module view is currently active. UI under construction.</p>
            </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    // Global Storage for fetched records
    window.fetchedData = {};

    // 1. DATE SETUP & CREATION LOG AUTO-STAMP
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });

    setInterval(() => {
        const logField = document.getElementById('creationLog');
        if(logField && !logField.value.includes('Updated')) {
            logField.value = `Created: ${new Date().toLocaleString('en-IN')} | User: JD-Admin`;
        }
    }, 1000);

    // Load Active Company from Memory on Startup
    document.addEventListener("DOMContentLoaded", () => {
        const savedCompany = localStorage.getItem('activeCompany');
        if(savedCompany) {
            updateActiveCompanyUI(savedCompany);
        }
    });

    // 2. MENU CONFIGURATION
    const menuStructure = [
      { id: 'company', label: 'Company', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4', subs: ['Add', 'View'] },
      { id: 'ledgers', label: 'Ledgers', icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253' },
      { id: 'vouchers', label: 'Vouchers', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4' },
      { id: 'stock', label: 'Stock', icon: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' },
      { id: 'projects', label: 'Projects', icon: 'M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z' },
      { id: 'users', label: 'Users', icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z' },
      { id: 'employees', label: 'Employees', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' },
      { id: 'sales-team', label: 'Sales Team', icon: 'M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' }
    ];

    const specificMenus = [
      { id: 'gst', label: 'GST', subs: ['GSTR1 Report'], icon: 'M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z' },
      { id: 'smart-crm', label: 'Smart CRM', subs: ['Due Reminders', 'Send Check / Payment Akn to Creditors'], icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' },
      { id: 'settings', label: 'Settings', subs: ['Night / Day Mode'], icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' },
      { id: 'help', label: 'Help', subs: ['Contact Us'], icon: 'M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' }
    ];

    const menuContainer = document.getElementById('menu-container');

    menuStructure.forEach(item => {
      const subs = item.subs || ['Add', 'Edit', 'View', 'Report'];
      const html = `
        <li>
          <button onclick="toggleMenu('${item.id}')" class="w-full flex items-center justify-between px-4 py-2.5 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800/50 transition-all group">
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 shrink-0 group-hover:text-[#5453EC] transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}" /></svg>
              <span class="font-medium text-sm">${item.label}</span>
            </div>
            <svg id="arrow-${item.id}" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </button>
          <ul id="sub-${item.id}" class="hidden mt-1 mb-2 ml-4 pl-4 border-l border-slate-700/50 space-y-1">
            ${subs.map(s => `<li><button onclick="navigateTo('${item.id}-${s.toLowerCase()}', '${item.label} > ${s}')" class="w-full text-left px-3 py-2 text-sm text-slate-500 hover:text-white rounded-lg hover:bg-slate-800/50 transition-colors">${s}</button></li>`).join('')}
          </ul>
        </li>
      `;
      menuContainer.insertAdjacentHTML('beforeend', html);
    });

    specificMenus.forEach(item => {
      let subsHtml = item.subs.map(sub => {
        if (sub === 'Night / Day Mode') {
          return `<li><button onclick="toggleDarkMode()" class="w-full text-left px-3 py-2 text-sm text-emerald-400 font-semibold hover:text-emerald-300 rounded-lg hover:bg-slate-800/50 transition-colors flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>${sub}</button></li>`;
        }
        const cleanId = item.id + '-' + sub.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        return `<li><button onclick="navigateTo('${cleanId}', '${item.label} > ${sub}')" class="w-full text-left px-3 py-2 text-sm text-slate-500 hover:text-white rounded-lg hover:bg-slate-800/50 transition-colors">${sub}</button></li>`;
      }).join('');
      
      const html = `
        <li class="${item.id === 'settings' ? 'pt-4 mt-4 border-t border-slate-700/50' : ''}">
          <button onclick="toggleMenu('${item.id}')" class="w-full flex items-center justify-between px-4 py-2.5 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800/50 transition-all group">
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 shrink-0 group-hover:text-[#5453EC] transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}" /></svg>
              <span class="font-medium text-sm">${item.label}</span>
            </div>
            <svg id="arrow-${item.id}" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </button>
          <ul id="sub-${item.id}" class="hidden mt-1 mb-2 ml-4 pl-4 border-l border-slate-700/50 space-y-1">${subsHtml}</ul>
        </li>
      `;
      menuContainer.insertAdjacentHTML('beforeend', html);
    });

    // 3. UI LOGIC
    function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('-translate-x-full');
      if(sidebar.classList.contains('-translate-x-full')) {
          overlay.classList.add('opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 300);
      } else {
          overlay.classList.remove('hidden'); setTimeout(() => overlay.classList.remove('opacity-0'), 10);
      }
    }
    function toggleMenu(id) {
      const el = document.getElementById(`sub-${id}`);
      const arrow = document.getElementById(`arrow-${id}`);
      if (el.classList.contains('hidden')) { el.classList.remove('hidden'); arrow.style.transform = 'rotate(180deg)'; } 
      else { el.classList.add('hidden'); arrow.style.transform = 'rotate(0deg)'; }
    }

    function navigateTo(routeId, title = 'Dashboard') {
      document.getElementById('page-title').textContent = title;
      document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));

      if (routeId === 'dashboard') {
          document.getElementById('view-dashboard').classList.remove('hidden');
      } else {
          const targetView = document.getElementById('view-' + routeId);
          if (targetView) {
              targetView.classList.remove('hidden');
              if (routeId === 'company-add') resetCompanyForm();
              if (routeId === 'company-view') loadViewData('COMPANY');
          } else {
              document.getElementById('module-placeholder').classList.remove('hidden');
              document.getElementById('module-title').textContent = title;
          }
      }
      if (window.innerWidth < 1024) toggleSidebar();
    }

    // 4. FORM RESET, EDIT, & DELETE LOGIC
    function selectCompany(companyName) {
        localStorage.setItem('activeCompany', companyName);
        updateActiveCompanyUI(companyName);
        alert(`Active Company set to: ${companyName}`);
    }

    function updateActiveCompanyUI(name) {
        const headerName = document.getElementById('active-company-name');
        const sidebarName = document.getElementById('company-name-sidebar');
        if (headerName) headerName.textContent = name;
        if (sidebarName) sidebarName.textContent = name;
    }

    function resetCompanyForm() {
        const form = document.getElementById('companyForm');
        if(form) {
            form.reset();
            document.getElementById('company-action').value = 'ADD';
            document.getElementById('company-editId').value = '';
            document.getElementById('display-company-id').value = 'Auto-Generated';
            document.getElementById('company-form-title').textContent = 'Create Company';
            document.getElementById('company-submit-btn').innerHTML = 'Generate ID & Save';
            document.getElementById('creationLog').value = `Created: ${new Date().toLocaleString('en-IN')} | User: JD-Admin`;
        }
    }

    function editRecord(sheetName, id) {
        if(!window.fetchedData || !window.fetchedData[sheetName]) return;
        const record = window.fetchedData[sheetName].find(r => r['Company ID'] === id);
        if(!record) return;

        navigateTo('company-add', 'Edit Company');

        const form = document.getElementById('companyForm');
        document.getElementById('company-action').value = 'UPDATE';
        document.getElementById('company-editId').value = id;
        document.getElementById('display-company-id').value = id;
        document.getElementById('company-form-title').textContent = 'Edit Company (' + id + ')';
        document.getElementById('company-submit-btn').innerHTML = 'Update Company Data';

        if(form.companyName) form.companyName.value = record['Company Name'] || '';
        if(form.constitution) form.constitution.value = record['Constitution of Business'] || '';
        if(form.address1) form.address1.value = record['Address Line 1'] || '';
        if(form.address2) form.address2.value = record['Address Line 2'] || '';
        if(form.state) form.state.value = record['State'] || '';
        if(form.pincode) form.pincode.value = record['Pincode'] || '';
        if(form.telephone) form.telephone.value = record['Telephone'] || '';
        if(form.mobile && record['Mobile']) form.mobile.value = record['Mobile'].toString().replace(/^91/, '');
        if(form.whatsapp && record['Whatsapp No']) form.whatsapp.value = record['Whatsapp No'].toString().replace(/^91/, '');
        if(form.email) form.email.value = record['Email'] || '';
        if(form.website) form.website.value = record['Website'] || '';
        if(form.companyDataPath) form.companyDataPath.value = record['Company Data Path'] || '';
        if(form.gstNo) form.gstNo.value = record['GST No'] || '';
        if(form.createdLog) form.createdLog.value = `Updated: ${new Date().toLocaleString('en-IN')} | By: JD-Admin`;

        const parseDate = (d) => {
            if(!d) return '';
            const p = d.split(/[-/T]/);
            if(p.length >= 3) return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
            return d;
        };
        if(form.fyBeginning) form.fyBeginning.value = parseDate(record['Financial Year Beginning From']);
        if(form.booksBeginning) form.booksBeginning.value = parseDate(record['Books Beginning From']);
    }

    async function deleteRecord(sheetName, id) {
        if (!confirm(`WARNING: Are you sure you want to delete ${id}?\n\nThis action cannot be undone.`)) {
            return;
        }
        
        const loader = document.getElementById('global-loader');
        loader.classList.remove('hidden');

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sheet: sheetName, action: 'DELETE', deleteId: id })
            });
            alert(`Record ${id} Deleted Successfully!`);
            loadViewData(sheetName); 
        } catch (err) {
            alert("Network Error. Check connection.");
        } finally {
            loader.classList.add('hidden');
        }
    }

    // 5. CHART.JS
    function initCharts() {
      if(!document.getElementById('plChart')) return;
      const plCtx = document.getElementById('plChart').getContext('2d');
      new Chart(plCtx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [
            { label: 'Revenue', data: [65000, 72000, 68000, 85000, 92000, 88000], borderColor: '#5453EC', backgroundColor: 'rgba(84, 83, 236, 0.1)', fill: true, tension: 0.4 },
            { label: 'Expenses', data: [35000, 38000, 36000, 42000, 45000, 43000], borderColor: '#EF4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      const revCtx = document.getElementById('revenueChart').getContext('2d');
      new Chart(revCtx, {
        type: 'doughnut',
        data: { labels: ['Products', 'Services', 'Sub'], datasets: [{ data: [45, 35, 20], backgroundColor: ['#5453EC', '#10b981', '#F7CB51'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
      });
    }
    setTimeout(initCharts, 100);

    // 6. GOOGLE SCRIPT COMMS
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCrgRlNT8GCxmd5Smk1LYnDVFg6BX6IwdxCJQLW-y4TB7Lh6-TIsJ9Ynvef8RFj1yr/exec";

    async function submitForm(e, sheetName) {
      e.preventDefault();
      const form = e.target;
      const loader = document.getElementById('global-loader');
      loader.classList.remove('hidden');

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      data.sheet = sheetName;

      if(data.mobile) data.mobile = "91" + data.mobile;
      if(data.whatsapp) data.whatsapp = "91" + data.whatsapp;

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        alert(sheetName + (data.action === "UPDATE" ? " Data Updated Successfully!" : " Data Saved Successfully!"));
        if(sheetName === 'COMPANY') resetCompanyForm();
        else form.reset();
      } catch (err) {
        alert("Network Error. Check connection.");
      } finally {
        loader.classList.add('hidden');
      }
    }

    async function loadViewData(sheetName) {
      const tableBody = document.getElementById('company-table-body');
      const loader = document.getElementById('global-loader');
      
      tableBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500 font-bold animate-pulse">Fetching data from Google Sheets...</td></tr>';
      loader.classList.remove('hidden');

      try {
        const response = await fetch(SCRIPT_URL + "?sheet=" + sheetName);
        const json = await response.json();
        
        if (json.status === "success") {
          window.fetchedData[sheetName] = json.data; 
          tableBody.innerHTML = '';
          
          if(json.data.length === 0) {
              tableBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">No records found.</td></tr>';
              return;
          }
          
          json.data.reverse().forEach(row => { 
            const tr = document.createElement('tr');
            tr.className = "border-b border-slate-50 dark:border-slate-700 hover:bg-slate-50/80 dark:hover:bg-slate-800 transition-colors text-sm text-slate-700 dark:text-slate-300";
            tr.innerHTML = `
              <td class="p-4 font-bold text-[#5453EC]">${row['Company ID'] || '--'}</td>
              <td class="p-4 font-bold text-slate-800 dark:text-white">${row['Company Name'] || '--'}</td>
              <td class="p-4"><span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-3 py-1 rounded-lg text-[10px] font-bold uppercase">${row['Constitution of Business'] || '--'}</span></td>
              <td class="p-4">${row['State'] || '--'}</td>
              <td class="p-4">${row['Mobile'] || '--'}</td>
              <td class="p-4">
                <div class="flex items-center gap-2 justify-end">
                  <button onclick="selectCompany('${row['Company Name']}')" class="text-emerald-600 hover:text-emerald-800 dark:text-emerald-400 dark:hover:text-emerald-300 text-xs font-bold bg-emerald-50 dark:bg-emerald-900/30 px-3 py-1.5 rounded-lg transition-colors shadow-sm">Select</button>
                  <button onclick="editRecord('${sheetName}', '${row['Company ID']}')" class="text-[#5453EC] hover:text-indigo-800 dark:hover:text-indigo-300 text-xs font-bold bg-indigo-50 dark:bg-indigo-900/30 px-3 py-1.5 rounded-lg transition-colors shadow-sm">Edit</button>
                  <button onclick="deleteRecord('${sheetName}', '${row['Company ID']}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-xs font-bold bg-red-50 dark:bg-red-900/30 px-3 py-1.5 rounded-lg transition-colors shadow-sm">Delete</button>
                </div>
              </td>
            `;
            tableBody.appendChild(tr);
          });
        }
      } catch (err) {
        tableBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-500 font-bold">Failed to load data.</td></tr>';
      } finally {
        loader.classList.add('hidden');
      }
    }

    async function syncAllData() {
      const syncIcon = document.getElementById('sync-icon');
      if (syncIcon) syncIcon.classList.add('animate-spin');
      if (!document.getElementById('view-company-view').classList.contains('hidden')) {
          await loadViewData('COMPANY');
      } else {
          await new Promise(r => setTimeout(r, 1000));
          alert("All Enterprise Data Synced.");
      }
      if (syncIcon) syncIcon.classList.remove('animate-spin');
    }
  </script>
</body>
</html>
